#!/bin/bash

pomodoro_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null && pwd )"
pomodoro_logs_dir="$pomodoro_dir/logs"
pomodoro_log_editor="${EDITOR:-xdg-open}"
pomodoro_settings="$HOME/.pomodoro.rc"

if [[ -e $pomodoro_settings ]]; then
  source $pomodoro_settings
fi

source `msh lib x11`

pomolog_file="$pomodoro_logs_dir/$(date +%Y.%m.%d).md"
today_link="$pomodoro_logs_dir/today.md"
before_link="$pomodoro_logs_dir/before.md"
start_timestamp="$(date)"
pomo=${1:-1}
start_pomo=$pomo

mkdir -p "$pomodoro_logs_dir"
cd "$pomodoro_logs_dir"

function write_log() {
  local msg="${2:-###} [$(date +%H:%M)] ${1:-}"
  echo -e "$msg"
  echo -e "$msg" >> "$pomolog_file"
}
function write_log_raw() {
  echo -e "$1"
  echo -e "$1" >> $pomolog_file
}
function write_log_horiz_sep() {
  write_log_raw "--------------------------------------------------------------------------------\n"
}

function show_log_editor() {
  _msh_focus_or_exec "$pomodoro_log_editor" "$(realpath "$today_link")"
}

# if there's a pomodoro already running, just show the log
THIS_PID=$$
if pgrep "$(basename "${BASH_SOURCE[0]}")" | grep -v $THIS_PID &>/dev/null; then
  write_log
  show_log_editor
  exit 0
fi

if [[ ! -e $pomolog_file ]]; then
  # check if the today_link is valid, because maybe user deleted today's entry
  # and wants to start a new one
  pomolog_before_file="$(realpath "$today_link")"
  if [ -f "$pomolog_before_file" ]; then
    # if the today_link points to a valid file, then we keep it as the new
    # 'before'
    ln -srf "$pomolog_before_file" "$before_link"
  fi

  write_log_raw "# :pomodoro: $(date) || +pomodoro due:$(date --date=tomorrow +%Y-%m-%d)"
  write_log_horiz_sep

  ln -srf "$pomolog_file" "$today_link"
fi

function xok {
  xmessage -default okay $@
}

function xyesno {
  xmessage -default yes -buttons yes:0,no:1 $@
}

xyesno -nearmouse -file - <<EOF
Plan session? Take notes?
EOF

LAST_POMO_RELATIVE=$(realpath --relative-to="$pomodoro_logs_dir" "$before_link")
write_log_raw "## Recall and Plan\n"
write_log_raw "Last Pomodoro: [$(basename "$LAST_POMO_RELATIVE")]($LAST_POMO_RELATIVE)"
write_log_raw "> TODO bring in some stats from last pomo, like projects and tasks\n"

write_log

if [ "$?" = "0" ]; then
  show_log_editor
fi

xok "Start session"

while true; do
  write_log "Pomodoro $pomo"
  sleep $((25*60))
  write_log "End Pomodoro $pomo"

# TAKE NOTES
xyesno -nearmouse -file - <<EOF
End of pomodoro $pomo

Take notes?
EOF

  if [ "$?" = "0" ]; then
    write_log "Take notes"
    show_log_editor
  fi

# TAKE A BREAK heh?
xyesno -nearmouse -file - <<EOF
Take a break?
EOF

# POMODORO?
xyesno -nearmouse -file - <<EOF
Pomodoro $((pomo+1))?
EOF

  if [ "$?" == "1" ]; then
    bye_stats="\n## Summary\n- started: $start_timestamp\n- ended:  $(date)\n- pomodoros: $((pomo - start_pomo + 1))"
    write_log "End Session\n$bye_stats\n--------------------------------------------------------------------------------"
    echo -e "$bye_stats" | xok -nearmouse -file -
    exit 0
  fi

  let "pomo = pomo + 1";
done
